#!/bin/bash
set -e

echo "üîÑ –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ Yuki VPN —Å–µ—Ä–≤–µ—Ä–∞..."

# –û—Å—Ç–∞–Ω–æ–≤–∫–∞ —Å–µ—Ä–≤–∏—Å–∞
echo "‚è∏Ô∏è  –û—Å—Ç–∞–Ω–æ–≤–∫–∞ —Å–µ—Ä–≤–∏—Å–∞..."
sudo systemctl stop yuki-vpn || true

# –ü–µ—Ä–µ—Ö–æ–¥ –≤ –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—é —Å–µ—Ä–≤–µ—Ä–∞
cd /opt/yuki-vpn/server

# –°–±–æ—Ä–∫–∞ –Ω–æ–≤–æ–≥–æ –±–∏–Ω–∞—Ä–Ω–∏–∫–∞
echo "üî® –ü–µ—Ä–µ—Å–±–æ—Ä–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞..."
go build -o yuki-server .

# –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –ø—Ä–∞–≤
chmod +x yuki-server

# –£–¥–∞–ª–µ–Ω–∏–µ —Å—Ç–∞—Ä–æ–≥–æ TUN –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–∞ (–µ—Å–ª–∏ –µ—Å—Ç—å)
echo "üßπ –û—á–∏—Å—Ç–∫–∞ —Å—Ç–∞—Ä—ã—Ö –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–æ–≤..."
sudo ip link delete tun0 2>/dev/null || true

# –ü–µ—Ä–µ–∑–∞–ø—É—Å–∫ —Å–µ—Ä–≤–∏—Å–∞
echo "üöÄ –ó–∞–ø—É—Å–∫ —Å–µ—Ä–≤–∏—Å–∞..."
sudo systemctl start yuki-vpn

# –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å—Ç–∞—Ç—É—Å–∞
echo "üìä –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å—Ç–∞—Ç—É—Å–∞..."
sleep 2
sudo systemctl status yuki-vpn --no-pager

# –ü—Ä–æ–≤–µ—Ä–∫–∞ TUN –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–∞
echo ""
echo "üîç –ü—Ä–æ–≤–µ—Ä–∫–∞ TUN –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–∞:"
ip addr show tun0 || echo "‚ö†Ô∏è  TUN –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å –Ω–µ —Å–æ–∑–¥–∞–Ω!"

# –ü—Ä–æ–≤–µ—Ä–∫–∞ –ª–æ–≥–æ–≤
echo ""
echo "üìã –ü–æ—Å–ª–µ–¥–Ω–∏–µ –ª–æ–≥–∏:"
sudo journalctl -u yuki-vpn -n 20 --no-pager

echo ""
echo "‚úÖ –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∑–∞–≤–µ—Ä—à–µ–Ω–æ!"
echo "üîó –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –ø–æ–¥–∫–ª—é—á–∏—Ç—å—Å—è –∫–ª–∏–µ–Ω—Ç–æ–º"
