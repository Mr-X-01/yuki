<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Yuki VPN - Admin Panel</title>
    <script src="https://unpkg.com/alpinejs@3.x.x/dist/cdn.min.js" defer></script>
    <script src="https://unpkg.com/htmx.org@1.9.10"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background: #0f172a; color: #e2e8f0; }
        .container { max-width: 1200px; margin: 0 auto; padding: 20px; }
        .header { background: linear-gradient(135deg, #1e293b, #334155); padding: 30px; border-radius: 15px; margin-bottom: 30px; text-align: center; }
        .logo { font-size: 2.5rem; font-weight: bold; color: #f472b6; margin-bottom: 10px; }
        .subtitle { color: #94a3b8; font-size: 1.1rem; }
        .stats-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 20px; margin-bottom: 30px; }
        .stat-card { background: #1e293b; padding: 25px; border-radius: 12px; border: 1px solid #334155; }
        .stat-title { font-size: 0.9rem; color: #94a3b8; margin-bottom: 5px; text-transform: uppercase; }
        .stat-value { font-size: 2rem; font-weight: bold; color: #f472b6; }
        .panel { background: #1e293b; border-radius: 15px; padding: 30px; margin-bottom: 20px; border: 1px solid #334155; }
        .panel-header { display: flex; justify-content: between; align-items: center; margin-bottom: 25px; }
        .panel-title { font-size: 1.4rem; font-weight: bold; color: #f1f5f9; }
        .btn { padding: 10px 20px; border: none; border-radius: 8px; cursor: pointer; font-weight: 500; transition: all 0.2s; }
        .btn-primary { background: #f472b6; color: #0f172a; }
        .btn-primary:hover { background: #ec4899; }
        .btn-danger { background: #ef4444; color: white; }
        .btn-danger:hover { background: #dc2626; }
        .btn-success { background: #10b981; color: white; }
        .btn-success:hover { background: #059669; }
        .input-group { margin-bottom: 20px; }
        .input-group label { display: block; margin-bottom: 8px; color: #cbd5e1; font-weight: 500; }
        .input-group input, .input-group select { width: 100%; padding: 12px; border: 1px solid #475569; border-radius: 8px; background: #334155; color: #e2e8f0; font-size: 14px; }
        .input-group input:focus { outline: none; border-color: #f472b6; }
        table { width: 100%; border-collapse: collapse; }
        th, td { padding: 15px; text-align: left; border-bottom: 1px solid #334155; }
        th { background: #334155; color: #f1f5f9; font-weight: 600; }
        tr:hover { background: #2563eb20; }
        .status-active { color: #10b981; font-weight: bold; }
        .status-inactive { color: #94a3b8; }
        .status-blocked { color: #ef4444; font-weight: bold; }
        .config-output { background: #0f172a; border: 1px solid #475569; border-radius: 8px; padding: 15px; margin-top: 15px; font-family: 'Courier New', monospace; font-size: 13px; max-height: 200px; overflow-y: auto; }
        .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); z-index: 1000; }
        .modal-content { background: #1e293b; margin: 5% auto; padding: 30px; width: 90%; max-width: 500px; border-radius: 15px; border: 1px solid #334155; }
        .close { float: right; font-size: 28px; font-weight: bold; cursor: pointer; color: #94a3b8; }
        .close:hover { color: #f472b6; }
        .flex { display: flex; gap: 10px; align-items: center; }
        .text-sm { font-size: 0.875rem; }
        .mb-4 { margin-bottom: 1rem; }
    </style>
</head>
<body x-data="adminPanel()">
    
    <div class="container">
        <!-- Header -->
        <div class="header">
            <div class="logo">üå∏ Yuki VPN</div>
            <div class="subtitle">–ê–¥–º–∏–Ω-–ø–∞–Ω–µ–ª—å —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è —Å–µ—Ä–≤–µ—Ä–æ–º</div>
        </div>

        <!-- Stats -->
        <div class="stats-grid">
            <div class="stat-card">
                <div class="stat-title">–í—Å–µ–≥–æ –∫–ª–∏–µ–Ω—Ç–æ–≤</div>
                <div class="stat-value" x-text="stats.total_clients">0</div>
            </div>
            <div class="stat-card">
                <div class="stat-title">–ê–∫—Ç–∏–≤–Ω—ã—Ö</div>
                <div class="stat-value" x-text="stats.active_clients">0</div>
            </div>
            <div class="stat-card">
                <div class="stat-title">–¢—Ä–∞—Ñ–∏–∫ ‚Üë</div>
                <div class="stat-value" x-text="formatBytes(stats.total_traffic_up)">0 B</div>
            </div>
            <div class="stat-card">
                <div class="stat-title">–¢—Ä–∞—Ñ–∏–∫ ‚Üì</div>
                <div class="stat-value" x-text="formatBytes(stats.total_traffic_down)">0 B</div>
            </div>
        </div>

        <!-- Create Client Panel -->
        <div class="panel">
            <div class="panel-header">
                <h2 class="panel-title">–°–æ–∑–¥–∞—Ç—å –Ω–æ–≤–æ–≥–æ –∫–ª–∏–µ–Ω—Ç–∞</h2>
            </div>
            <form @submit.prevent="createClient()">
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">
                    <div class="input-group">
                        <label>–ò–º—è –∫–ª–∏–µ–Ω—Ç–∞</label>
                        <input type="text" x-model="newClient.name" required>
                    </div>
                    <div class="input-group">
                        <label>–õ–∏–º–∏—Ç —Ç—Ä–∞—Ñ–∏–∫–∞ (GB, 0 = –±–µ–∑ –ª–∏–º–∏—Ç–∞)</label>
                        <input type="number" x-model="newClient.bandwidth" min="0" value="0">
                    </div>
                </div>
                <div class="flex">
                    <button type="submit" class="btn btn-primary">–°–æ–∑–¥–∞—Ç—å –∫–ª–∏–µ–Ω—Ç–∞</button>
                </div>
            </form>
            
            <div x-show="lastCreatedConfig" class="config-output" style="margin-top: 20px;">
                <strong>–ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è –¥–ª—è –∫–ª–∏–µ–Ω—Ç–∞:</strong>
                <pre x-text="lastCreatedConfig"></pre>
                <button @click="copyConfig()" class="btn btn-success" style="margin-top: 10px;">–°–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å</button>
            </div>
        </div>

        <!-- Clients List -->
        <div class="panel">
            <div class="panel-header">
                <h2 class="panel-title">–°–ø–∏—Å–æ–∫ –∫–ª–∏–µ–Ω—Ç–æ–≤</h2>
                <button @click="loadClients()" class="btn btn-primary">üîÑ –û–±–Ω–æ–≤–∏—Ç—å</button>
            </div>
            
            <table>
                <thead>
                    <tr>
                        <th>ID</th>
                        <th>–ò–º—è</th>
                        <th>–°—Ç–∞—Ç—É—Å</th>
                        <th>–°–æ–∑–¥–∞–Ω</th>
                        <th>–¢—Ä–∞—Ñ–∏–∫ ‚Üë/‚Üì</th>
                        <th>–î–µ–π—Å—Ç–≤–∏—è</th>
                    </tr>
                </thead>
                <tbody>
                    <template x-for="client in clients" :key="client.id">
                        <tr>
                            <td class="text-sm" x-text="client.id.substring(0, 8) + '...'"></td>
                            <td x-text="client.name"></td>
                            <td>
                                <span :class="{
                                    'status-active': client.active && !client.blocked,
                                    'status-inactive': !client.active && !client.blocked,
                                    'status-blocked': client.blocked
                                }" x-text="client.blocked ? '–ó–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω' : (client.active ? '–ê–∫—Ç–∏–≤–µ–Ω' : '–ù–µ–∞–∫—Ç–∏–≤–µ–Ω')"></span>
                            </td>
                            <td x-text="formatDate(client.created)"></td>
                            <td x-text="formatBytes(client.bytes_up) + ' / ' + formatBytes(client.bytes_down)"></td>
                            <td>
                                <div class="flex">
                                    <button @click="toggleBlock(client)" 
                                        :class="client.blocked ? 'btn btn-success' : 'btn btn-danger'"
                                        x-text="client.blocked ? '–†–∞–∑–±–ª–æ–∫.' : '–ë–ª–æ–∫.'">
                                    </button>
                                    <button @click="deleteClient(client.id)" class="btn btn-danger">–£–¥–∞–ª–∏—Ç—å</button>
                                </div>
                            </td>
                        </tr>
                    </template>
                </tbody>
            </table>
        </div>

        <!-- API Settings -->
        <div class="panel">
            <div class="panel-header">
                <h2 class="panel-title">–ù–∞—Å—Ç—Ä–æ–π–∫–∏ API</h2>
            </div>
            <div class="input-group">
                <label>API Key</label>
                <input type="password" x-model="apiKey" placeholder="–í–≤–µ–¥–∏—Ç–µ API –∫–ª—é—á">
            </div>
            <div class="input-group">
                <label>Server URL</label>
                <input type="text" x-model="serverUrl" placeholder="https://your-domain.ru">
            </div>
            <button @click="saveSettings()" class="btn btn-primary">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å –Ω–∞—Å—Ç—Ä–æ–π–∫–∏</button>
        </div>
    </div>

    <script>
        function adminPanel() {
            return {
                apiKey: localStorage.getItem('yuki_api_key') || '',
                serverUrl: localStorage.getItem('yuki_server_url') || window.location.origin,
                clients: [],
                stats: {
                    total_clients: 0,
                    active_clients: 0,
                    total_traffic_up: 0,
                    total_traffic_down: 0
                },
                newClient: {
                    name: '',
                    bandwidth: 0
                },
                lastCreatedConfig: '',

                async init() {
                    await this.loadStats();
                    await this.loadClients();
                    setInterval(() => this.loadStats(), 30000);
                },

                async apiRequest(endpoint, options = {}) {
                    const url = `${this.serverUrl}/admin${endpoint}`;
                    const headers = {
                        'Content-Type': 'application/json',
                        'X-API-Key': this.apiKey,
                        ...options.headers
                    };

                    try {
                        const response = await fetch(url, { ...options, headers });
                        if (!response.ok) {
                            throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                        }
                        return await response.json();
                    } catch (error) {
                        alert(`API Error: ${error.message}`);
                        throw error;
                    }
                },

                async loadStats() {
                    try {
                        this.stats = await this.apiRequest('/stats');
                    } catch (error) {
                        console.error('Failed to load stats:', error);
                    }
                },

                async loadClients() {
                    try {
                        this.clients = await this.apiRequest('/clients');
                    } catch (error) {
                        console.error('Failed to load clients:', error);
                    }
                },

                async createClient() {
                    if (!this.newClient.name.trim()) {
                        alert('–í–≤–µ–¥–∏—Ç–µ –∏–º—è –∫–ª–∏–µ–Ω—Ç–∞');
                        return;
                    }

                    try {
                        const bandwidth = this.newClient.bandwidth > 0 ? this.newClient.bandwidth * 1024 * 1024 * 1024 : 0;
                        const client = await this.apiRequest('/clients', {
                            method: 'POST',
                            body: JSON.stringify({
                                name: this.newClient.name,
                                max_bandwidth: bandwidth
                            })
                        });

                        this.lastCreatedConfig = client.config;
                        this.newClient = { name: '', bandwidth: 0 };
                        await this.loadClients();
                        await this.loadStats();
                        
                        alert('‚úÖ –ö–ª–∏–µ–Ω—Ç —Å–æ–∑–¥–∞–Ω —É—Å–ø–µ—à–Ω–æ!');
                    } catch (error) {
                        console.error('Failed to create client:', error);
                    }
                },

                async toggleBlock(client) {
                    try {
                        const action = client.blocked ? 'unblock' : 'block';
                        await this.apiRequest(`/clients/${client.id}/${action}`, { method: 'POST' });
                        await this.loadClients();
                        
                        const status = client.blocked ? '—Ä–∞–∑–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω' : '–∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω';
                        alert(`‚úÖ –ö–ª–∏–µ–Ω—Ç ${status}`);
                    } catch (error) {
                        console.error('Failed to toggle block:', error);
                    }
                },

                async deleteClient(clientId) {
                    if (!confirm('–£–¥–∞–ª–∏—Ç—å –∫–ª–∏–µ–Ω—Ç–∞? –≠—Ç–æ –¥–µ–π—Å—Ç–≤–∏–µ –Ω–µ–æ–±—Ä–∞—Ç–∏–º–æ.')) return;

                    try {
                        await this.apiRequest(`/clients/${clientId}`, { method: 'DELETE' });
                        await this.loadClients();
                        await this.loadStats();
                        
                        alert('‚úÖ –ö–ª–∏–µ–Ω—Ç —É–¥–∞–ª–µ–Ω');
                    } catch (error) {
                        console.error('Failed to delete client:', error);
                    }
                },

                saveSettings() {
                    localStorage.setItem('yuki_api_key', this.apiKey);
                    localStorage.setItem('yuki_server_url', this.serverUrl);
                    alert('‚úÖ –ù–∞—Å—Ç—Ä–æ–π–∫–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã');
                },

                copyConfig() {
                    navigator.clipboard.writeText(this.lastCreatedConfig).then(() => {
                        alert('‚úÖ –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è —Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∞');
                    });
                },

                formatBytes(bytes) {
                    if (bytes === 0) return '0 B';
                    const k = 1024;
                    const sizes = ['B', 'KB', 'MB', 'GB', 'TB'];
                    const i = Math.floor(Math.log(bytes) / Math.log(k));
                    return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
                },

                formatDate(dateString) {
                    return new Date(dateString).toLocaleString('ru-RU');
                }
            }
        }
    </script>
</body>
</html>
