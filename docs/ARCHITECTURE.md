# Архитектура Yuki VPN

## Обзор системы

Yuki VPN - это полностью кастомный VPN-сервис, разработанный для работы в условиях жёсткой цензуры. Основная особенность - полная маскировка под обычный российский gRPC API сервис.

## Компоненты системы

```
┌─────────────────┐    ┌─────────────────┐    ┌─────────────────┐
│   Windows       │    │   gRPC Server   │    │   Admin Panel   │
│   Client        │◄──►│   (Port 443)    │◄──►│   (Port 3000)   │
└─────────────────┘    └─────────────────┘    └─────────────────┘
        │                        │                        │
        │                        ▼                        │
        │              ┌─────────────────┐                │
        └─────────────►│ REST API        │◄───────────────┘
                       │ (Port 8443)     │
                       └─────────────────┘
                                │
                                ▼
                       ┌─────────────────┐
                       │ Redis Database  │
                       │ (Port 6379)     │
                       └─────────────────┘
```

## Сетевая архитектура

### 1. Транспортный уровень

- **TLS 1.3** - обязательное шифрование всего трафика
- **HTTP/2** - базовый протокол для gRPC
- **gRPC** - маскировка туннельного трафика

### 2. Протокольный стек

```
┌─────────────────────────────────────┐
│           IP Пакеты                 │  ← Реальный трафик пользователя
├─────────────────────────────────────┤
│      Кастомные фреймы               │  ← Наш протокол (Type+Length+Data)
├─────────────────────────────────────┤
│    XChaCha20-Poly1305               │  ← Шифрование
├─────────────────────────────────────┤
│         gRPC фреймы                 │  ← Маскировка
├─────────────────────────────────────┤
│          HTTP/2                     │  ← Транспорт
├─────────────────────────────────────┤
│          TLS 1.3                    │  ← Защита канала
├─────────────────────────────────────┤
│           TCP                       │  ← Базовый протокол
└─────────────────────────────────────┘
```

## Маскировка и обход DPI

### 1. gRPC маскировка

Первые 128-256 байт каждого соединения - валидные gRPC фреймы:

```go
// Пример легитимного gRPC запроса
service TunnelService {
  rpc GetStatus(StatusRequest) returns (StatusResponse);
  rpc GetMetrics(MetricsRequest) returns (MetricsResponse);
  rpc Connect(stream TunnelFrame) returns (stream TunnelFrame);  // ← Туннель
}
```

### 2. JA3/JA4 Fingerprinting

- Используем стандартные Go crypto/tls настройки
- Fingerprint идентичен обычному Go HTTP клиенту
- Никаких кастомных cipher suites или расширений

### 3. Поведенческая маскировка

- Переменные размеры пакетов (100-1400 байт)
- Реалистичные интервалы между пакетами (10-100ms)
- Периодические ping/pong для имитации keep-alive

## Криптография

### 1. Алгоритм шифрования

**XChaCha20-Poly1305**:
- Ключ: 256 бит (32 байта)
- Nonce: 192 бита (24 байта) 
- Аутентификация: Poly1305 MAC (128 бит)

### 2. Схема шифрования

```
Plaintext → [XChaCha20-Poly1305] → Ciphertext
    ↓              ↓                    ↓
Frame Data    Nonce (24) + Key (32)  Nonce + Encrypted + MAC
```

### 3. Nonce управление

- Каждое соединение: уникальные отправка/получение nonce
- Инкремент как big-endian счётчик
- Защита от replay атак через последовательную проверку

## Кастомный протокол фреймов

### Структура фрейма

```
 0                   1                   2                   3
 0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1
├─┼─┼─┼─┼─┼─┼─┼─┼─┼─┼─┼─┼─┼─┼─┼─┼─┼─┼─┼─┼─┼─┼─┼─┼─┼─┼─┼─┼─┼─┼─┼─┤
│                    Length (4 bytes, big-endian)                │
├─┼─┼─┼─┼─┼─┼─┼─┼─┼─┼─┼─┼─┼─┼─┼─┼─┼─┼─┼─┼─┼─┼─┼─┼─┼─┼─┼─┼─┼─┼─┼─┤
│     Type      │              Data Length (3 bytes)            │
├─┼─┼─┼─┼─┼─┼─┼─┼─┼─┼─┼─┼─┼─┼─┼─┼─┼─┼─┼─┼─┼─┼─┼─┼─┼─┼─┼─┼─┼─┼─┼─┤
│                         Data (variable)                        │
└─┴─┴─┴─┴─┴─┴─┴─┴─┴─┴─┴─┴─┴─┴─┴─┴─┴─┴─┴─┴─┴─┴─┴─┴─┴─┴─┴─┴─┴─┴─┴─┘
```

### Типы фреймов

- **Type 0**: Данные (IP пакеты)
- **Type 1**: Ping (keep-alive от клиента)
- **Type 2**: Pong (ответ сервера)

## Управление клиентами

### 1. Аутентификация

```go
type Client struct {
    ID          string    // UUID v4
    Secret      string    // 64-символьный токен
    Created     time.Time
    ExpiresAt   *time.Time
    Active      bool
    Blocked     bool
    BytesUp     int64
    BytesDown   int64
    MaxBandwidth int64
}
```

### 2. REST API эндпоинты

```
POST   /admin/clients           - Создать клиента
GET    /admin/clients           - Список клиентов  
DELETE /admin/clients/{uuid}    - Удалить клиента
POST   /admin/clients/{uuid}/block   - Заблокировать
POST   /admin/clients/{uuid}/unblock - Разблокировать
GET    /admin/stats             - Статистика сервера
```

### 3. Хранение данных

- **Redis**: Активные сессии, временные ключи
- **JSON файлы**: Постоянные данные клиентов
- **SQLite** (опционально): Для больших инсталляций

## TUN интерфейс (Windows)

### 1. Драйверы

- **WinTun**: основной и предпочтительный (kernel-mode, высокая производительность). Инсталляция автоматизируется скриптом `client-windows/install-wintun.ps1`.
- **TAP-Windows**: fallback для совместимости, если WinTun недоступен.

### 2. Сетевая конфигурация

```
TUN Interface: 10.8.0.2/24
Gateway:      10.8.0.1  
DNS:          1.1.1.1, 8.8.8.8
MTU:          1420 (для избежания фрагментации)
```

### 3. Маршрутизация

```batch
# Все через VPN кроме локальной сети
route add 0.0.0.0 mask 0.0.0.0 10.8.0.1 metric 1
route add 192.168.0.0 mask 255.255.0.0 192.168.1.1 metric 256
```

### 4. Взаимодействие с драйвером и безопасность

- Данные читаются/пишутся через кольцевые буферы WinTun.
- Взаимодействие с памятью драйвера требует `unsafe` в Go; используется `unsafe.Slice` + `copy()` для безопасного копирования, а также точечные `// nolint`-аннотации на критичных участках.
- Для Windows CLI используется вспомогательный вызов `netsh` для первичной конфигурации IP/маски/шлюза интерфейса.

### 5. Порты и Nginx

- Рекомендуется поднимать gRPC-сервер на `127.0.0.1:50051`, а наружу отдавать только 443 (HTTPS) через Nginx.
- Nginx проксирует `location /tunnel.TunnelService/` на внутренний порт gRPC, обеспечивая маскировку трафика.

## Производительность

### 1. Оптимизации

- **Zero-copy**: Минимальное копирование буферов
- **Batch processing**: Обработка нескольких пакетов за раз
- **Connection pooling**: Переиспользование gRPC соединений
- **Compression**: Опциональное lz4 сжатие для медленных каналов

### 2. Ожидаемые характеристики

- **Latency overhead**: +2-5ms
- **Throughput**: 90-95% от прямого канала
- **CPU usage**: 5-15% на 100 Mbps
- **Memory**: ~50MB на 1000 активных клиентов

## Безопасность

### 1. Уровни защиты

1. **TLS 1.3** - защита канала передачи
2. **XChaCha20** - защита содержимого
3. **gRPC auth** - аутентификация соединений
4. **API keys** - защита админ интерфейса
5. **Rate limiting** - защита от DoS

### 2. Угрозы и защита

| Угроза | Защита |
|--------|--------|
| DPI анализ | gRPC маскировка + валидные фреймы |
| Traffic analysis | Случайные padding + переменные интервалы |
| Replay атаки | Nonce sequence validation |
| Bruteforce | Rate limiting + временная блокировка |
| MitM | Certificate pinning + TLS 1.3 |

## Мониторинг

### 1. Метрики сервера

```json
{
  "connections": 150,
  "bandwidth_total": "1.2GB/s", 
  "cpu_usage": "12%",
  "memory_usage": "256MB",
  "uptime": "7d 14h 32m"
}
```

### 2. Логирование

- **Уровень ERROR**: Только критичные ошибки
- **Никаких IP адресов**: Только хэши для отладки
- **Ротация логов**: 7 дней, максимум 100MB

## Развёртывание

### 1. Минимальная конфигурация

- **CPU**: 1 vCore
- **RAM**: 512MB
- **Storage**: 10GB SSD
- **Bandwidth**: 100 Mbps

### 2. Рекомендуемая конфигурация

- **CPU**: 2 vCores  
- **RAM**: 2GB
- **Storage**: 20GB SSD
- **Bandwidth**: 1 Gbps

### 3. Масштабирование

- **Horizontal**: Load balancer + несколько серверов
- **Vertical**: До 4 vCores эффективно
- **Geographic**: Серверы в разных регионах РФ
